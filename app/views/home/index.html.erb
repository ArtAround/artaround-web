<% content_for :body_class, "home" %>
<% content_for :footer do %>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&callback=loadMap"></script>
<% end %>

<% content_for :head do %>

  <script type="text/javascript">
    var map;
    var geocoder;
    
    var arts = [];
    var icons = {};
    
    var searchMarker;
    var searchInfoWindow;    
    
    var markers = [];
  
    var currentInfoWindow;
    
    <% @arts.each do |art| %>
      arts.push({
        id: "<%= art.to_param %>",
        title: "<%= escape_javascript art.title %>",
        category: "<%= escape_javascript art.category %>",
        neighborhood: "<%= escape_javascript art.neighborhood %>",
        ward: "<%= art.ward %>",
        artist: "<%= escape_javascript art.artist %>",
        year: "<%= escape_javascript art.year.to_s %>",
        flickr_id: "<%= (art.flickr_ids || []).first %>",
        commissioned: <%= art.commissioned? %>,
        latitude: <%= art.latitude || 0 %>,
        longitude: <%= art.longitude || 0 %>
      });
    <% end %>
  
    function loadMap() {
      var location = new google.maps.LatLng(38.9043, -77.035);
    
      map = new google.maps.Map(document.getElementById("map_canvas"), {
        center: location,
        zoom: 12,
        scrollwheel: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });
      
      var wards = new google.maps.KmlLayer("http://theartaround.us/kml/dc.kml", {
        preserveViewport: true
      });
      wards.setMap(map);
      
      // icon types
      icons.blue = new google.maps.MarkerImage("/images/marker_blue.png");
      icons.red = new google.maps.MarkerImage("/images/marker_red.png");
      icons.museum = new google.maps.MarkerImage("/images/museum.png");
      
      $.each(arts, function(i, art) {
        var marker = markerFor(art, map);
        
        marker.filters = {
          category: (art.category || "Unknown").toLowerCase(), 
          commissioned: art.commissioned,
          ward: art.ward
        };
        markers.push(marker);
        
        marker.setMap(map);
      });
      
      geocoder = new google.maps.Geocoder();
      $("ul#location button.searchBtn").click(function() {
        var query = $("ul#location #id_location").val();
        geocoder.geocode({
          address: query,
          region: "us"
        }, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            map.setZoom(15);
            
            searchMarker = new google.maps.Marker({position: results[0].geometry.location});
            searchMarker.setMap(map);
              
            map.panTo(results[0].geometry.location);
          }
        });
      });
    }
    
    function markerFor(art, map) {
      var location = new google.maps.LatLng(art.latitude, art.longitude);
      
      var html = '<div class="mapBubble">' +
        '<a class="bubbleimg" id="bubbleimg-' + art.id + '" href="/arts/' + art.id + '" target="_blank">Image</a>' +
        '<div class="bubbleMetaData">' +
            '<dl>' +
                '<dt>Title</dt>' +
                '<dd>' + art.title + '</dd>' +
            
                '<dt>Artist</dt>' +
                '<dd>' + (art.artist || "Unknown") + '</dd>' +
            
                '<dt>Erected</dt>' +
                '<dd>' + (art.year || "Unknown") + '</dd>' +
            
                '<dt>Neighborhood</dt>' +
                '<dd>' + (art.neighborhood || "Unknown") + '</dd>' +
            '</dl>' +
            '<a href="/arts/' + art.id + '" target="_blank">More Information</a>' +
        '</div>' +
      '</div>';
      
      var icon = (art.category == 'Museum' || art.category == 'Gallery' || art.category == 'Market') ? icons.museum : icons.red;
      
      var marker = new google.maps.Marker({
        position: location,
        icon: icon,
        title: art.title
      });
      
      google.maps.event.addListener(marker, "click", function() {
        clearWindow();
        
        currentInfoWindow = new google.maps.InfoWindow({content: html});
        currentInfoWindow.open(map, marker);
        
        if (art.flickr_id) {
          Flickr.getThumbnail(art.flickr_id, "Medium", function(thumbnail) {
            if (thumbnail)
              $("#bubbleimg-" + art.id).css("background-image", "url(\"" + thumbnail.source + "\")");
          });
        }
      });
      
      return marker;
    }
    
    function recalculateFilter() {
        clearWindow();
        
        // figure out commission filter
        var ensure_commissioned;
        if ($("#filter_commissioned_all")[0].checked)
          ensure_commissioned = false;
        else if ($("#filter_commissioned_only")[0].checked)
          ensure_commissioned = true;
          
          
        var all_categories = $("#filter_category_all")[0].checked;
        var just_museum = $("#filter_category_museum")[0].checked;
        var just_gallery = $("#filter_category_gallery")[0].checked;
        
        var just_public = $("#filter_category_public")[0].checked;
        var allowed_categories = [];
        if (just_public) {
          $("input.filter.public").each(function(i, element) {
            if (element.checked)
              allowed_categories.push($(this).next("span.category").html().toLowerCase());
          });
        }
        
        var specific_ward = $("#id_wards").val();
          
        // go through each marker and ensure it passes the test
        $.each(markers, function(i, marker) {
          var passed_commission;
          var passed_category;
          var passed_ward;
          
          // examine for commissioned status
          passed_commission = (!ensure_commissioned || (ensure_commissioned && marker.filters.commissioned));
          
          if (all_categories)
            passed_category = true;
          else if (just_museum)
            passed_category = (marker.filters.category == "museum");
          else if (just_gallery)
            passed_category = (marker.filters.category == "gallery");
          else if (just_public)
            passed_category = ($.inArray(marker.filters.category, allowed_categories) >= 0);
          else
            passed_category = false;
          
          passed_wards = !specific_ward || (specific_ward == marker.filters.ward);
          
          marker.setVisible(passed_commission && passed_category && passed_wards);
        });
      }
    
    $(function() {
      
      // filter checkboxes/radio/select widgets
      $("input.filter").click(recalculateFilter);
      $("select#id_wards").change(recalculateFilter);
      
      // hide/show links
      $(".hideCategory").click(
        function() {
          $("#categoryScroll").slideUp();
          $(".hideCategory").hide();
          $(".showCategory").show();
          return false;
        }
      );
      
      $(".showCategory").click(
        function() {
          $("#categoryScroll").slideDown();
          $(".showCategory").hide();
          $(".hideCategory").show();
          return false;
        }
      );
      
      $(".hideCommissioned").click(
        function() {
          $("#commissionedScroll").slideUp();
          $(".hideCommissioned").hide();
          $(".showCommissioned").show();
          return false;
        }
      );
      
      $(".showCommissioned").click(
        function() {
          $("#commissionedScroll").slideDown();
          $(".showCommissioned").hide();
          $(".hideCommissioned").show();
          return false;
        }
      );
      
      $(".hideLocation").click(
        function() {
          $("#location").slideUp();
          $(".hideLocation").hide();
          $(".showLocation").show();
          return false;
        }
      );
      
      $(".showLocation").click(
        function() {
          $("#location").slideDown();
          $(".showLocation").hide();
          $(".hideLocation").show();
          return false;
        }
      );
    });
    
    function clearWindow() {
      if (currentInfoWindow) currentInfoWindow.close();
    }
  </script>
  
<% end %>


<div id="featureBoxWrapper">       
  <div id="featureBox">
    <div id="mainText">
      <h2>Discover the art around us</h2>
      <span>find and map the graffiti you love to the mural we missed</span>
    </div>
    <div id="curateBox">
      <span>Know of some art around you?</span>
      <a class="buttonLink" id="curateButton" href="/arts/new">Curate it now!</a>
    </div>  
    <div class="clear"></div>
  </div>
</div>

<div id="mapSearchWrapper">
  <div id="mapSearch">
    <form action="#" onsubmit="return false">
      <label>Zoom me down to an address or zip in DC</label>
      <input id="id_mapsearch" type="text" />
      <button class="searchBtn" type="submit">
          <span>Search</span>
      </button>
    </form>
  </div>  
</div>

<div id="mapContainer">
  <form id="filterForm" action="." method="get" onsubmit="return false">
    <fieldset>
      <legend>Look for</legend>
      <a class="hideCategory" href="#">Hide</a>
      <a class="showCategory" href="#">Show</a>
      
      <div class="clear"></div>
      
      <ul id="categoryScroll">
        <li>
          <label>
            <input class="filter radio" type="radio" name="category" id="filter_category_all" checked />
            <span>all</span>
          </label>
        </li>
        
        <li>
          <label>
            <input class="filter category radio" name="category" type="radio" id="filter_category_museum" />
            <span>museum</span>
          </label>
        </li>
        
        <li>
          <label>
            <input class="filter category radio" name="category" type="radio" id="filter_category_gallery" />
            <span>gallery</span>
          </label>
        </li>
        
        <li>
          <label>
            <input class="filter radio" name="category" type="radio" id="filter_category_public" />
            <span>public</span>
          </label>
          
          <div class="clear"></div>
          
          <ul id="publicSubset">
            <% categories.reject {|c| ["Museum", "Gallery"].include? c}.each do |category| %>
              <li>
                <label>
                  <input class="filter checkbox category public" name="public_category" type="checkbox" checked />
                  <span class="category"><%= category.downcase %></span>
                </label>
              </li>
            <% end %>
          </ul>
          
        </li>
      </ul>
    </fieldset>
    
    <fieldset>
      <legend>Funded By</legend>
      <a class="hideCommissioned" href="#">Hide</a>
      <a class="showCommissioned" href="#">Show</a>
      <div class="clear"></div>
      
      <ul id="commissionedScroll">
        <li>
          <label>
            <input class="filter commissioned radio" type="radio" name="commissioned" id="filter_commissioned_all" checked />
            <span>anyone</span>
          </label>
        </li>
        <li>
          <label>
            <input class="filter radio" type="radio" name="commissioned" id="filter_commissioned_only" />
            <span>the District</span>
          </label>
        </li>
      </ul>
    </fieldset>
    
    <fieldset>
      <legend>Located In</legend>
      <a href="#" class="hideLocation">Hide</a>
      <a href="#" class="showLocation">Show</a>
      <div class="clear"></div>
      
      <ul id="location">
        <li> 
          <label>Zoom to an address or zip</label>
          <input type="text" id="id_location" />
          <button type="submit" class="searchBtn">
              <span>Go</span>
          </button>
        </li>
        
        <li>
          <label for="id_wards">DC Wards</label> 
          <select id="id_wards" name="wards">
              <option selected="selected" value="">---------</option>
              <option value="1">Ward 1</option>
              <option value="2">Ward 2</option>
              <option value="3">Ward 3</option>
              <option value="4">Ward 4</option>
              <option value="5">Ward 5</option>
              <option value="6">Ward 6</option>
              <option value="7">Ward 7</option>
              <option value="8">Ward 8</option>
          </select>
        </li>
      </ul>

    </fieldset>

  </form>
  
  <div id="map_canvas"></div>
  
</div>
